<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Expert - System.Sagenav</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@300;400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-tech { font-family: 'Orbitron', sans-serif; }
        .admin-card { background: white; border-radius: 1.5rem; padding: 1.5rem; border: 1px solid #e2e8f0; }
        .tab-active { border-bottom: 4px solid #3b82f6; color: #3b82f6; font-weight: 900; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURACIÓN DE SUPABASE ---
        const SB_URL = 'https://hzvqpoboonpqnyvpvrdj.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6dnFwb2Jvb25wcW55dnB2cmRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NDA0NjYsImV4cCI6MjA4MjExNjQ2Nn0.9JmSj7mDPXR81avoYEGmKXjCMPwktmk6PMIFQyS2XMc';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        function AdminApp() {
            const [authorized, setAuthorized] = useState(false);
            const [adminTab, setAdminTab] = useState('billing');
            const [loading, setLoading] = useState(true);

            // Estados de Datos
            const [settings, setSettings] = useState({
                heroTitle: "", whatsapp: "", footerText: "",
                personalName: "", personalId: "", personalAddress: "", personalEmail: "", personalRut: "",
                bgImages: [], personalLogo: null
            });
            const [inventory, setInventory] = useState([]);
            const [sales, setSales] = useState([]);

            // Formulario Nuevo Item
            const [newItem, setNewItem] = useState({ name: "", price: "", type: "Producto", img: "" });
            
            // Formulario Cobro
            const [billClient, setBillClient] = useState({ name: "", nit: "", date: new Date().toISOString().split('T')[0] });
            const [billItems, setBillItems] = useState([]);
            const [manualItem, setManualItem] = useState({ desc: "", price: "" });
            
            const chartRef = useRef(null);
            const myChart = useRef(null);

            useEffect(() => {
                const pass = prompt("Clave del Doctor:");
                if (pass === "1234") {
                    setAuthorized(true);
                    fetchData();
                } else { window.location.href = "index.html"; }
            }, []);

            async function fetchData() {
                const { data } = await supabaseClient.from('sagenav_data').select('*');
                if (data) {
                    const s = data.find(d => d.key === 'settings').value;
                    setSettings({ ...settings, ...s });
                    setInventory(data.find(d => d.key === 'inventory').value || []);
                    setSales(data.find(d => d.key === 'sales')?.value || []);
                }
                setLoading(false);
            }

            const saveEverything = async () => {
                const { error: e1 } = await supabaseClient.from('sagenav_data').update({ value: settings }).eq('key', 'settings');
                const { error: e2 } = await supabaseClient.from('sagenav_data').update({ value: inventory }).eq('key', 'inventory');
                const { error: e3 } = await supabaseClient.from('sagenav_data').update({ value: sales }).eq('key', 'sales');
                if (!e1 && !e2 && !e3) alert("✅ Datos actualizados en la nube");
                else alert("❌ Error al sincronizar");
            };

            const generatePDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Encabezado con datos del "Doctor"
                if (settings.personalLogo) doc.addImage(settings.personalLogo, 'PNG', 15, 10, 25, 25);
                
                doc.setFont("helvetica", "bold").setFontSize(16);
                doc.text(settings.personalName || "SYSTEM SAGENAV", 50, 20);
                doc.setFontSize(9).setFont("helvetica", "normal");
                doc.text(`NIT/CC: ${settings.personalId}`, 50, 25);
                doc.text(`Dirección: ${settings.personalAddress}`, 50, 30);
                if(settings.personalRut) doc.text(`RUT: ${settings.personalRut}`, 50, 35);

                doc.setFontSize(18).setFont("helvetica", "bold").text("CUENTA DE COBRO", 105, 55, { align: "center" });
                
                // Datos Cliente
                doc.setFontSize(10).setFont("helvetica", "bold").text("PARA:", 15, 70);
                doc.setFont("helvetica", "normal").text(`CLIENTE: ${billClient.name.toUpperCase()}`, 15, 75);
                doc.text(`NIT/CC: ${billClient.nit}`, 15, 80);
                doc.text(`FECHA: ${billClient.date}`, 160, 75);

                const tableBody = billItems.map(i => [1, i.name.toUpperCase(), `$${i.price.toLocaleString()}`, `$${i.price.toLocaleString()}`]);
                if (manualItem.desc) tableBody.push([1, manualItem.desc.toUpperCase(), `$${parseInt(manualItem.price).toLocaleString()}`, `$${parseInt(manualItem.price).toLocaleString()}`]);
                
                doc.autoTable({ startY: 90, head: [['CANT', 'DESCRIPCIÓN', 'VR. UNIT', 'TOTAL']], body: tableBody, theme: 'striped', headStyles: {fillColor: [15, 23, 42]} });
                
                const finalY = doc.lastAutoTable.finalY + 10;
                const total = tableBody.reduce((acc, curr) => acc + parseInt(curr[3].replace(/[^0-9]/g, '')), 0);
                doc.setFont("helvetica", "bold").setFontSize(12).text(`TOTAL A PAGAR: $${total.toLocaleString()}`, 15, finalY);

                // Pie de página legal
                doc.setFontSize(8).setFont("helvetica", "italic");
                doc.text("Esta cuenta de cobro se asimila en todos sus efectos a una letra de cambio según Art. 774 del código de comercio.", 105, finalY + 20, { align: "center" });

                doc.save(`CTA_${billClient.name}.pdf`);
                setSales([{ id: Date.now(), date: billClient.date, amount: total, concept: `Cobro: ${billClient.name}` }, ...sales]);
            };

            const handleFile = (e, type) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onloadend = () => {
                    if (type === 'prod') setNewItem({...newItem, img: reader.result});
                    if (type === 'logo') setSettings({...settings, personalLogo: reader.result});
                    if (type === 'bg') setSettings({...settings, bgImages: [...(settings.bgImages || []), reader.result]});
                };
                if (file) reader.readAsDataURL(file);
            };

            if (!authorized || loading) return <div className="p-20 text-center font-tech animate-pulse">CARGANDO...</div>;

            return (
                <div className="p-4 md:p-10 max-w-6xl mx-auto">
                    <header className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <div className="flex items-center gap-3">
                            <div className="bg-slate-900 text-white p-3 rounded-2xl"><i data-lucide="shield-check"></i></div>
                            <h1 className="text-2xl font-black font-tech italic uppercase">Panel Doctor</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={saveEverything} className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg flex items-center gap-2">
                                <i data-lucide="cloud-upload" size={16}></i> GUARDAR TODO
                            </button>
                        </div>
                    </header>

                    <nav className="flex gap-4 mb-8 border-b overflow-x-auto pb-2 no-scrollbar text-[10px] font-bold uppercase tracking-widest">
                        <button onClick={()=>setAdminTab('billing')} className={adminTab==='billing'?'tab-active':''}>Facturación</button>
                        <button onClick={()=>setAdminTab('inventory')} className={adminTab==='inventory'?'tab-active':''}>Inventario</button>
                        <button onClick={()=>setAdminTab('reports')} className={adminTab==='reports'?'tab-active':''}>Ventas</button>
                        <button onClick={()=>setAdminTab('config')} className={adminTab==='config'?'tab-active':''}>Ajustes</button>
                    </nav>

                    {adminTab === 'billing' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-in fade-in">
                            <div className="admin-card space-y-4">
                                <h3 className="font-bold text-blue-600 uppercase text-xs">Crear Cobro</h3>
                                <input placeholder="Nombre Cliente" className="w-full p-3 border rounded-xl" value={billClient.name} onChange={e=>setBillClient({...billClient, name:e.target.value})} />
                                <input placeholder="NIT / Cédula Cliente" className="w-full p-3 border rounded-xl" value={billClient.nit} onChange={e=>setBillClient({...billClient, nit:e.target.value})} />
                                <select className="w-full p-3 border rounded-xl" onChange={e=>{
                                    const it = inventory.find(i=>i.id == e.target.value);
                                    if(it) setBillItems([...billItems, it]);
                                }}>
                                    <option value="">Añadir de Inventario...</option>
                                    {inventory.map(i=><option key={i.id} value={i.id}>[{i.type}] {i.name} - ${i.price}</option>)}
                                </select>
                                <div className="flex gap-2">
                                    <input placeholder="Ítem Manual" className="flex-grow p-3 border rounded-xl" value={manualItem.desc} onChange={e=>setManualItem({...manualItem, desc:e.target.value})} />
                                    <input placeholder="$" type="number" className="w-24 p-3 border rounded-xl" value={manualItem.price} onChange={e=>setManualItem({...manualItem, price:e.target.value})} />
                                </div>
                                <button onClick={generatePDF} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2">
                                    <i data-lucide="file-text"></i> GENERAR PDF
                                </button>
                            </div>
                            <div className="admin-card">
                                <h3 className="font-bold text-slate-400 uppercase text-xs mb-4">Resumen</h3>
                                {billItems.map((item, idx)=>(
                                    <div key={idx} className="flex justify-between border-b py-2 text-sm uppercase">
                                        <span>{item.name}</span>
                                        <b>${item.price.toLocaleString()}</b>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {adminTab === 'inventory' && (
                        <div className="admin-card animate-in fade-in">
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <input placeholder="Nombre" className="p-3 border rounded-xl" value={newItem.name} onChange={e=>setNewItem({...newItem, name:e.target.value})} />
                                <input placeholder="Precio" type="number" className="p-3 border rounded-xl" value={newItem.price} onChange={e=>setNewItem({...newItem, price:parseInt(e.target.value)})} />
                                <select className="p-3 border rounded-xl font-bold" value={newItem.type} onChange={e=>setNewItem({...newItem, type:e.target.value})}>
                                    <option value="Producto">Producto</option>
                                    <option value="Servicio">Servicio</option>
                                </select>
                                <input type="file" onChange={e=>handleFile(e, 'prod')} className="text-[10px]" />
                            </div>
                            <button onClick={()=>{setInventory([...inventory, {...newItem, id:Date.now()}]); setNewItem({name:"", price:"", type:"Producto", img:""})}} className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold uppercase text-xs mb-6">Agregar Ítem</button>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {inventory.map(item=>(
                                    <div key={item.id} className="p-4 border rounded-2xl relative bg-white shadow-sm">
                                        <button onClick={()=>setInventory(inventory.filter(i=>i.id!==item.id))} className="absolute top-2 right-2 text-red-300 hover:text-red-600 text-xl">×</button>
                                        <span className={`text-[8px] font-bold px-2 py-1 rounded-full ${item.type==='Producto'?'bg-orange-100 text-orange-600':'bg-blue-100 text-blue-600'}`}>{item.type}</span>
                                        <p className="font-bold text-xs mt-2 uppercase">{item.name}</p>
                                        <p className="text-blue-600 font-black">${item.price.toLocaleString()}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {adminTab === 'config' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-in fade-in">
                            <div className="admin-card space-y-4">
                                <h3 className="font-bold text-blue-600 border-b pb-2 uppercase text-xs">Mis Datos (Emisor)</h3>
                                <input placeholder="Tu Nombre o Empresa" className="w-full p-3 border rounded-xl" value={settings.personalName} onChange={e=>setSettings({...settings, personalName:e.target.value})} />
                                <input placeholder="NIT / Cédula" className="w-full p-3 border rounded-xl" value={settings.personalId} onChange={e=>setSettings({...settings, personalId:e.target.value})} />
                                <input placeholder="Dirección Física" className="w-full p-3 border rounded-xl" value={settings.personalAddress} onChange={e=>setSettings({...settings, personalAddress:e.target.value})} />
                                <input placeholder="RUT (Opcional)" className="w-full p-3 border rounded-xl" value={settings.personalRut} onChange={e=>setSettings({...settings, personalRut:e.target.value})} />
                                <input placeholder="WhatsApp (Ej: 57300...)" className="w-full p-3 border rounded-xl" value={settings.whatsapp} onChange={e=>setSettings({...settings, whatsapp:e.target.value})} />
                            </div>
                            <div className="admin-card space-y-4">
                                <h3 className="font-bold text-blue-600 border-b pb-2 uppercase text-xs">Personalización Web</h3>
                                <input placeholder="Título de la Web" className="w-full p-3 border rounded-xl" value={settings.heroTitle} onChange={e=>setSettings({...settings, heroTitle:e.target.value})} />
                                <textarea placeholder="Texto de Pie de Página (Footer)" className="w-full p-3 border rounded-xl h-24" value={settings.footerText} onChange={e=>setSettings({...settings, footerText:e.target.value})} />
                                <div>
                                    <label className="text-[10px] font-black uppercase opacity-50 block mb-1">Logo para Documentos:</label>
                                    <input type="file" onChange={e=>handleFile(e, 'logo')} className="text-xs" />
                                </div>
                                <button onClick={()=>setSettings({...settings, bgImages:[]})} className="text-red-500 text-[10px] font-bold">BORRAR FOTOS CARRUSEL</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>
</html>