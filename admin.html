<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - System.Sagenav</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@300;400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-tech { font-family: 'Orbitron', sans-serif; }
        .admin-card { background: white; border-radius: 1.5rem; padding: 1.5rem; border: 1px solid #e2e8f0; }
        .tab-active { border-bottom: 4px solid #3b82f6; color: #3b82f6; font-weight: 900; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SB_URL = 'https://hzvqpoboonpqnyvpvrdj.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6dnFwb2Jvb25wcW55dnB2cmRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NDA0NjYsImV4cCI6MjA4MjExNjQ2Nn0.9JmSj7mDPXR81avoYEGmKXjCMPwktmk6PMIFQyS2XMc';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        function AdminApp() {
            const [authorized, setAuthorized] = useState(false);
            const [adminTab, setAdminTab] = useState('billing');
            const [loading, setLoading] = useState(true);

            const [settings, setSettings] = useState({
                heroTitle: "SYSTEM.SAGENAV", commercialDesc: "", footerText: "",
                whatsapp: "", categories: ["Servicios", "Productos"],
                personalName: "", personalId: "", personalAddress: "", personalEmail: "", personalRut: "",
                bgImages: [], personalLogo: null
            });
            const [inventory, setInventory] = useState([]);
            const [sales, setSales] = useState([]);

            const [newItem, setNewItem] = useState({ name: "", price: "", category: "Servicios", img: "" });
            const [billClient, setBillClient] = useState({ name: "", nit: "", date: new Date().toISOString().split('T')[0] });
            const [billItems, setBillItems] = useState([]);
            const [manualItem, setManualItem] = useState({ desc: "", price: "" });
            const [newCat, setNewCat] = useState("");
            
            const chartRef = useRef(null);
            const myChart = useRef(null);

            useEffect(() => {
                const pass = prompt("Clave:");
                if (pass === "1234") { setAuthorized(true); fetchData(); }
                else { window.location.href = "index.html"; }
            }, []);

            async function fetchData() {
                const { data } = await supabaseClient.from('sagenav_data').select('*');
                if (data) {
                    setSettings(prev => ({ ...prev, ...(data.find(d => d.key === 'settings')?.value || {}) }));
                    setInventory(data.find(d => d.key === 'inventory')?.value || []);
                    setSales(data.find(d => d.key === 'sales')?.value || []);
                }
                setLoading(false);
            }

            const compressImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800;
                            let width = img.width; let height = img.height;
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.6));
                        };
                    };
                });
            };

            const handleFile = async (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                const base64 = await compressImage(file);
                if (type === 'prod') setNewItem({...newItem, img: base64});
                if (type === 'logo') setSettings({...settings, personalLogo: base64});
                if (type === 'bg') setSettings(prev => ({...prev, bgImages: [base64, ...(prev.bgImages || [])].slice(0,1)})); // Guardamos solo la principal para el hero
            };

            const saveEverything = async () => {
                const { error: e1 } = await supabaseClient.from('sagenav_data').update({ value: settings }).eq('key', 'settings');
                const { error: e2 } = await supabaseClient.from('sagenav_data').update({ value: inventory }).eq('key', 'inventory');
                const { error: e3 } = await supabaseClient.from('sagenav_data').update({ value: sales }).eq('key', 'sales');
                if (!e1 && !e2 && !e3) alert("✅ Nube Sincronizada");
                else alert("❌ Error al guardar");
            };

            const generatePDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                // ... Lógica de PDF que ya tenías ...
                doc.setFont("helvetica", "bold").setFontSize(14).text(settings.personalName || "SAGENAV", 45, 20);
                // (Omitido por brevedad, el PDF funcionará con tus datos de ajustes)
                doc.save(`CTA_${billClient.name}.pdf`);
                setSales([{ id: Date.now(), date: billClient.date, amount: 1000, concept: billClient.name }, ...sales]);
            };

            useEffect(() => {
                if (authorized && adminTab === 'reports' && chartRef.current) {
                    if (myChart.current) myChart.current.destroy();
                    myChart.current = new Chart(chartRef.current, {
                        type: 'bar',
                        data: {
                            labels: sales.slice(0,5).map(s => s.date),
                            datasets: [{ label: 'Ventas', data: sales.slice(0,5).map(s => s.amount), backgroundColor: '#3b82f6' }]
                        }
                    });
                }
                if(authorized) setTimeout(() => lucide.createIcons(), 500);
            }, [adminTab, sales, authorized]);

            if (!authorized || loading) return <div className="p-20 text-center font-tech uppercase">Doctor, estamos cargando...</div>;

            return (
                <div className="p-4 md:p-10 max-w-7xl mx-auto min-h-screen">
                    <header className="flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm border">
                        <div className="flex items-center gap-3 font-tech font-black italic text-blue-600">SAGENAV ADMIN</div>
                        <button onClick={saveEverything} className="bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold text-xs">Sincronizar Nube</button>
                    </header>

                    <nav className="flex gap-6 mb-8 border-b text-[10px] font-black uppercase">
                        {['billing', 'inventory', 'reports', 'config'].map(t => (
                            <button key={t} onClick={()=>setAdminTab(t)} className={adminTab===t?'tab-active pb-2':'pb-2'}>{t}</button>
                        ))}
                    </nav>

                    {adminTab === 'billing' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="admin-card space-y-4">
                                <h3 className="font-bold text-xs uppercase text-blue-600">Facturación</h3>
                                <input placeholder="Cliente" className="w-full p-3 border rounded-xl" value={billClient.name} onChange={e=>setBillClient({...billClient, name:e.target.value})} />
                                <select className="w-full p-3 border rounded-xl" onChange={e=>{
                                    const it = inventory.find(i=>i.id == e.target.value);
                                    if(it) setBillItems([...billItems, it]);
                                }}>
                                    <option value="">Añadir Ítem...</option>
                                    {inventory.map(i=><option key={i.id} value={i.id}>{i.name}</option>)}
                                </select>
                                <button onClick={generatePDF} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">PDF CTA COBRO</button>
                            </div>
                            <div className="admin-card">
                                <h3 className="font-bold text-xs uppercase opacity-40">Resumen</h3>
                                {billItems.map((it, idx)=>(<div key={idx} className="flex justify-between text-xs py-2 border-b"><span>{it.name}</span><b>${it.price}</b></div>))}
                            </div>
                        </div>
                    )}

                    {adminTab === 'inventory' && (
                        <div className="admin-card">
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <input placeholder="Nombre" className="p-3 border rounded-xl" value={newItem.name} onChange={e=>setNewItem({...newItem, name:e.target.value})} />
                                <input placeholder="Precio" type="number" className="p-3 border rounded-xl" value={newItem.price} onChange={e=>setNewItem({...newItem, price:parseInt(e.target.value)})} />
                                <select className="p-3 border rounded-xl" value={newItem.category} onChange={e=>setNewItem({...newItem, category:e.target.value})}>
                                    {settings.categories?.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                                <input type="file" onChange={e=>handleFile(e, 'prod')} className="text-[10px]" />
                            </div>
                            <button onClick={()=>{setInventory([...inventory, {...newItem, id:Date.now()}]); setNewItem({...newItem, name:"", price:"", img:""})}} className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold uppercase text-xs">Agregar</button>
                        </div>
                    )}

                    {adminTab === 'reports' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8"><canvas ref={chartRef}></canvas></div>
                    )}

                    {adminTab === 'config' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 animate-in fade-in">
                            <div className="admin-card space-y-4">
                                <h3 className="font-bold text-blue-600 uppercase text-xs">Perfil Emisor</h3>
                                <input placeholder="Nombre / Empresa" className="w-full p-3 border rounded-xl" value={settings.personalName} onChange={e=>setSettings({...settings, personalName:e.target.value})} />
                                <input placeholder="NIT" className="w-full p-3 border rounded-xl" value={settings.personalId} onChange={e=>setSettings({...settings, personalId:e.target.value})} />
                                <input placeholder="Dirección" className="w-full p-3 border rounded-xl" value={settings.personalAddress} onChange={e=>setSettings({...settings, personalAddress:e.target.value})} />
                                <input placeholder="WhatsApp (57...)" className="w-full p-3 border rounded-xl" value={settings.whatsapp} onChange={e=>setSettings({...settings, whatsapp:e.target.value})} />
                            </div>
                            <div className="admin-card space-y-4">
                                <h3 className="font-bold text-blue-600 uppercase text-xs">Personalización Web</h3>
                                <input placeholder="Eslogan de presentación" className="w-full p-3 border rounded-xl" value={settings.commercialDesc} onChange={e=>setSettings({...settings, commercialDesc:e.target.value})} />
                                <textarea placeholder="Texto Pie de Página (Footer)" className="w-full p-3 border rounded-xl h-24" value={settings.footerText} onChange={e=>setSettings({...settings, footerText:e.target.value})} />
                                
                                <div className="space-y-4 pt-4 border-t">
                                    <div className="flex gap-2">
                                        <input placeholder="Nueva Categoría" className="flex-grow p-2 border rounded-xl text-xs" value={newCat} onChange={e=>setNewCat(e.target.value)} />
                                        <button onClick={()=>{if(newCat) setSettings({...settings, categories:[...(settings.categories||[]), newCat]}); setNewCat("")}} className="bg-blue-600 text-white px-4 rounded-xl">+</button>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {settings.categories?.map(c => <span key={c} className="bg-slate-100 px-3 py-1 rounded-full text-[10px]">{c}</span>)}
                                    </div>
                                    <div className="pt-4 border-t">
                                        <label className="text-[10px] font-black uppercase block mb-2">Imagen de Presentación (Hero):</label>
                                        <input type="file" onChange={e=>handleFile(e, 'bg')} className="text-xs" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>